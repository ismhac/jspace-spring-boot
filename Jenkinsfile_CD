def requiredParameters() {
    if (params.GIT_SHA == '') {
        error("Require GIT SHA to deploy")
    }

    if (params.ENV == '') {
        error("Require ENV value to deploy")
    }
}

pipeline {
    agent any

    parameters {
        string(name: 'GIT_SHA', defaultValue: '', description: 'Input GIT SHA to deploy')
        choice(name: 'ENV', choices: ['dev', 'production'], description: 'Select environment to deploy')
        string(name: 'DOCKER_HUB_REPO', defaultValue: '', description: 'Input Docker Hub Repository')
        string(name: 'JASYPT_PW', defaultValue: '', description: 'Input Jasypt Password')
    }

    environment {
        ENVIRONMENT = "${params.ENV}"
        SERVICE_NAME = "erp-service"
        IMAGE_NAME = "${SERVICE_NAME}:${params.GIT_SHA}"
        PORT_CONFIGURATION = "-p 8081:8081"
        CONTAINER_NAME = "${SERVICE_NAME}-${params.GIT_SHA}"
        PROFILE_CONFIGURATION = "-e SPRING_PROFILES_ACTIVE=${params.ENV}"
    }

    stages{
        stage('Pull Image From Docker Hub') {
                steps {
                    echo "Pull Image from Docker Hub"
                    script {
                        withCredentials([usernamePassword(credentialsId: 'docker-hub-account', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            sh "sudo docker login -u ${USERNAME} -p ${PASSWORD}"
                            sh "sudo docker pull ${DOCKER_HUB_REPO}:${params.GIT_SHA}"
                        }
                    }
                }
            }

        stage('Stop current') {
            steps {
                script {
                    requiredParameters()
                    echo "Stop previous version"

                    if (ENVIRONMENT == "staging-naver") {
                        echo "Load docker image: ${IMAGE_NAME}"
                        withCredentials([usernamePassword(credentialsId: 'naver-server-account', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            def remote = [:]
                            remote.user = USERNAME
                            remote.password = PASSWORD

                            remote.name = "Naver dev"
                            remote.host = "175.45.200.78"
                            remote.allowAnyHosts = true
                            sshCommand remote: remote, command: "docker ps -q --filter name=${SERVICE_NAME} | xargs -r docker rm -f"
                        }
                    } else {
                        sh "sudo docker ps -q --filter name=${SERVICE_NAME} | xargs -r docker rm -f"
                    }
                }
            }
        }
        stage('Deploy EC2') {
            steps {
                script {
                    echo "Deploy to ${ENVIRONMENT}"

                    if (ENVIRONMENT == "staging-naver") {
                        echo "Load docker image: ${IMAGE_NAME}"
                        withCredentials([usernamePassword(credentialsId: 'naver-server-account', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            def remote = [:]
                            remote.user = USERNAME
                            remote.password = PASSWORD

                            remote.name = "Naver dev"
                            remote.host = "175.45.200.78"
                            remote.allowAnyHosts = true
                            sshCommand remote: remote, command: "docker run -dit --name ${CONTAINER_NAME} ${PORT_CONFIGURATION} ${NAVER_VOLUME_CONFIGURATINON} ${VOLUME_CONFIGURATINON} ${PROFILE_CONFIGURATION} ${ENCRYPTION_CONFIGURATION} ${IMAGE_NAME}"
                        }
                    } else {
                        sh "sudo docker run -dit --name ${CONTAINER_NAME} ${PORT_CONFIGURATION} ${DOCKER_HUB_REPO} ${PROFILE_CONFIGURATION} ${JASYPT_PW} ${IMAGE_NAME}"
                        sh "sudo docker ps"
                    }
                }
            }
        }
    }
}